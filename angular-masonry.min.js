angular.module("masonryLayout",[]).directive("masonryLayout",["$window",function(e){function c(){n=t.yMargin;r=t.xMargin;i=t.marginWidth;s=t.imgWidth;o=t.containers}var t,n,r,i,s,o,u,a,f,l;return{restrict:"A",require:"^masonryResize",link:function(e,u,a,l){var h=u.find("img"),p,d,v,m,g;u[0].style.cssText+="; left: -999px; top: -999px; opacity: 0; position:absolute; ";var y=function(){d=l.shortest();p=l.tallest();v=d*(s+r)+i;m=o[d];l.update(d,u[0].scrollHeight+n);u[0].style.cssText+="; left: "+v+"px; top: "+m+"px; opacity: 1;";if(++l.imagesLoadCount===l.totalItemCount){console.log("Correcting parent height");u.parent()[0].style.height=l.tallest()+"px"}};if(e.$index===0){t=l.dimensions();c();f=0}if(e.$last){l.totalItemCount=e.$index+1;u.parent()[0].style.height=l.tallest()+l.docHeight()+"px"}h.on("load",y);h.on("error",function(){l.imagesLoadCount++})}}}]).directive("masonryResize",["$window","$rootScope",function(e,t){var n=false,r;var i=t.masonryData,s=i.imgWidth,o=i.xMargin,u=i.yMargin,a=i.containerPadding,f=e.innerWidth,l,c,h,p,d,v,m;return{restrict:"A",controller:["$scope","$element",function(t,n){this.imagesLoadCount=0;this.totalItemCount=0;this.shortest=function(){return d.indexOf(d.slice().sort(function(e,t){return e-t})[0])};this.tallest=function(){return d.slice().sort(function(e,t){return t-e})[0]};this.dimensions=function(){return{xMargin:o,yMargin:u,windowWidth:f,containers:d,imgWidth:s,marginWidth:p}};this.update=function(e,t){d[e]+=t};this.reset=function(){document.body.style.overflow="scroll";l=n[0].clientWidth;document.body.style.overflow="auto";c=Math.floor((l+o)/(s+o));p=Math.abs((l-s*c-o*(c-1))/2);d=new Array(c)};this.init=function(){for(v=0,m=d.length;v<m;v++){d[v]=0}};this.shouldResize=function(){return Math.abs(f-e.innerWidth)>25?true:false};this.setWindowWidth=function(){f=e.innerWidth};this.docHeight=function(){return e.innerHeight*2.5}}],link:function(t,i,s,o){var u,a,f,l,c;var h=function(){if(o.shouldResize()&&!n){n=true;o.setWindowWidth();o.reset();o.init();r=o.dimensions();u=i[0].children;for(v=0,m=u.length;v<m-1;v++){f=o.shortest();a=u[v];l=f*(r.imgWidth+r.xMargin)+r.marginWidth;c=r.containers[f];a.style.cssText+="; opacity: 1; left: "+l+"px; top: "+c+"px;";o.update(f,a.scrollHeight+r.yMargin)}i[0].style.height=o.tallest()+"px";n=false}};t.$watch(function(){return i[0].children.length},function(e,t){if(e===0){i[0].style.height=0;o.totalItemCount=0;o.imagesLoadCount=0;o.init()}});angular.element(e).on("resize",h);t.$on("$destroy",function(){n=false;angular.element(e).off("resize")});i[0].style.position="relative";o.reset();o.init()}}}])